apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-init-sql
  namespace: susana-shop
data:
  init.sql: |
    SET NAMES utf8mb4;
    SET character_set_client = utf8mb4;
    SET FOREIGN_KEY_CHECKS = 0;

    -- Usar la base de datos susana_shop (ya creada por MYSQL_DATABASE)
    USE susana_shop;

    -- Eliminar tablas existentes si las hay
    DROP TABLE IF EXISTS detalle_pedidos;
    DROP TABLE IF EXISTS pedidos;
    DROP TABLE IF EXISTS carrito;
    DROP TABLE IF EXISTS productos;
    DROP TABLE IF EXISTS usuarios;

    -- ============================================
    -- CREAR TABLAS
    -- ============================================

    -- Tabla de usuarios
    CREATE TABLE usuarios (
        id INT AUTO_INCREMENT PRIMARY KEY,
        nombre VARCHAR(100) NOT NULL,
        email VARCHAR(100) UNIQUE NOT NULL,
        password VARCHAR(255) NOT NULL,
        rol ENUM('admin', 'cliente') DEFAULT 'cliente',
        fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        INDEX idx_email (email),
        INDEX idx_rol (rol)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

    -- Tabla de productos
    CREATE TABLE productos (
        id INT AUTO_INCREMENT PRIMARY KEY,
        nombre VARCHAR(150) NOT NULL,
        descripcion TEXT,
        precio DECIMAL(10,2) NOT NULL,
        stock INT DEFAULT 0,
        imagen VARCHAR(255),
        activo BOOLEAN DEFAULT TRUE,
        creado_en TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        INDEX idx_nombre (nombre),
        INDEX idx_precio (precio),
        INDEX idx_activo (activo)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

    -- Tabla de carrito
    CREATE TABLE carrito (
        id INT AUTO_INCREMENT PRIMARY KEY,
        usuario_id INT NOT NULL,
        producto_id INT NOT NULL,
        cantidad INT NOT NULL DEFAULT 1,
        agregado_en TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (usuario_id) REFERENCES usuarios(id) ON DELETE CASCADE,
        FOREIGN KEY (producto_id) REFERENCES productos(id) ON DELETE CASCADE,
        UNIQUE KEY unique_user_product (usuario_id, producto_id)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

    -- Tabla de pedidos
    CREATE TABLE pedidos (
        id INT AUTO_INCREMENT PRIMARY KEY,
        usuario_id INT NOT NULL,
        total DECIMAL(10,2) NOT NULL,
        estado ENUM('pendiente', 'pagado', 'enviado', 'completado', 'cancelado') DEFAULT 'pendiente',
        fecha_pedido TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (usuario_id) REFERENCES usuarios(id) ON DELETE CASCADE,
        INDEX idx_estado (estado),
        INDEX idx_fecha (fecha_pedido)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

    -- Tabla detalle de pedidos
    CREATE TABLE detalle_pedidos (
        id INT AUTO_INCREMENT PRIMARY KEY,
        pedido_id INT NOT NULL,
        producto_id INT NOT NULL,
        cantidad INT NOT NULL,
        precio DECIMAL(10,2) NOT NULL,
        FOREIGN KEY (pedido_id) REFERENCES pedidos(id) ON DELETE CASCADE,
        FOREIGN KEY (producto_id) REFERENCES productos(id) ON DELETE CASCADE
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

    -- ============================================
    -- INSERTAR DATOS INICIALES
    -- ============================================

    -- Usuario administrador (password: admin123)
    INSERT INTO usuarios (nombre, email, password, rol) VALUES
    ('Administrador', 'admin@tienda.com', '$2b$10$VEEsl9MyJrFgO6Y6m/RcaOrp6kR.NxQPcGjTfQkLM5q8vO0C6pA8e', 'admin');

    -- Usuarios clientes de ejemplo (password: admin123)
    INSERT INTO usuarios (nombre, email, password, rol) VALUES
    ('Juan Pérez', 'juan@example.com', '$2b$10$VEEsl9MyJrFgO6Y6m/RcaOrp6kR.NxQPcGjTfQkLM5q8vO0C6pA8e', 'cliente'),
    ('María García', 'maria@example.com', '$2b$10$VEEsl9MyJrFgO6Y6m/RcaOrp6kR.NxQPcGjTfQkLM5q8vO0C6pA8e', 'cliente'),
    ('Carlos López', 'carlos@example.com', '$2b$10$VEEsl9MyJrFgO6Y6m/RcaOrp6kR.NxQPcGjTfQkLM5q8vO0C6pA8e', 'cliente');

    -- Productos de belleza y cosméticos (activos)
    INSERT INTO productos (nombre, descripcion, precio, stock, imagen, activo) VALUES
    ('Pulidor de Uñas Profesional', 'Pulidor eléctrico de uñas con accesorios y cargador incluido. Ideal para uso profesional en salones de belleza.', 220.00, 15, 'uploads/master.png', TRUE),
    ('Cepillos Descartables', 'Pack de 50 cepillos desechables para uso cosmético y aplicación de pestañas. Material suave y seguro.', 25.00, 100, 'uploads/mcepillos.png', TRUE),
    ('Olla de Cera Eléctrica', 'Olla eléctrica portátil para derretir cera depilatoria. Control de temperatura ajustable y apagado automático.', 120.00, 20, 'uploads/ollita-de-cera.png', TRUE),
    ('Lámpara LED de Escritorio', 'Lámpara LED flexible recargable para escritorio. Perfecta para trabajo de detalle en manicure y maquillaje.', 60.00, 30, 'uploads/presson.png', TRUE),
    ('Pulidor de Uñas Premium', 'Pulidor profesional de alta potencia para manicure y pedicure. Incluye 6 cabezales intercambiables.', 350.00, 10, 'uploads/pulidor.png', TRUE),
    ('Pulidor Portátil Rosa', 'Pulidor recargable de uñas en formato compacto. Perfecto para retoques rápidos. Batería de larga duración.', 180.00, 25, 'uploads/pulidorp2.png', TRUE),
    ('Pestañas Venus', 'Extensiones de pestañas estilo natural marca Venus. Material premium de seda sintética. Volumen medio.', 90.00, 40, 'uploads/venus.png', TRUE),
    ('Cinta Adhesiva para Pestañas', 'Rollo de cinta adhesiva especial para extensiones de pestañas. Hipoalergénica y de fácil remoción.', 15.00, 200, 'uploads/vpestanas.png', TRUE),
    ('Mini Ventilador Portátil', 'Ventilador portátil de mano recargable en varios colores. USB recargable. Ideal para secar productos rápidamente.', 75.00, 35, 'uploads/vpestanas2.png', TRUE);

    -- Productos desactivados temporalmente
    INSERT INTO productos (nombre, descripcion, precio, stock, imagen, activo) VALUES
    ('Kit Completo de Manicure', 'Set profesional con cortauñas, limas, empujador de cutículas y más. Estuche de cuero incluido.', 140.00, 18, 'uploads/kit-manicure.png', FALSE),
    ('Gel UV para Uñas', 'Gel UV de alta calidad en diversos colores. Secado rápido bajo lámpara UV/LED. 15ml.', 45.00, 60, 'uploads/gel-uv.png', FALSE),
    ('Removedor de Esmalte', 'Removedor de esmalte sin acetona. Fórmula suave con vitamina E. 250ml.', 28.00, 80, 'uploads/removedor.png', FALSE),
    ('Base Coat Profesional', 'Base coat de larga duración. Protege las uñas naturales y mejora la adherencia del esmalte.', 35.00, 50, 'uploads/base-coat.png', FALSE),
    ('Top Coat Brillo', 'Top coat de secado rápido con acabado ultra brillante. Protección duradera hasta 14 días.', 38.00, 50, 'uploads/top-coat.png', FALSE),
    ('Lámpara UV/LED 48W', 'Lámpara profesional UV/LED de 48W. Secado rápido en 30 segundos. Temporizador digital incluido.', 280.00, 12, 'uploads/lampara-uv.png', FALSE);

    -- Items en carrito de ejemplo
    INSERT INTO carrito (usuario_id, producto_id, cantidad) VALUES
    (2, 1, 1),  -- Juan: Pulidor de Uñas
    (2, 2, 2),  -- Juan: 2 packs de Cepillos
    (3, 7, 1),  -- María: Pestañas Venus
    (3, 8, 3);  -- María: 3 Cintas Adhesivas

    -- Pedidos de ejemplo
    INSERT INTO pedidos (usuario_id, total, estado) VALUES
    (2, 270.00, 'completado'),
    (3, 135.00, 'enviado'),
    (4, 630.00, 'pendiente');

    -- Detalle de pedidos
    INSERT INTO detalle_pedidos (pedido_id, producto_id, cantidad, precio) VALUES
    -- Pedido 1 (Juan)
    (1, 1, 1, 220.00),
    (1, 2, 2, 25.00),
    -- Pedido 2 (María)
    (2, 7, 1, 90.00),
    (2, 8, 3, 15.00),
    -- Pedido 3 (Carlos)
    (3, 5, 1, 350.00),
    (3, 15, 1, 280.00);

    SET FOREIGN_KEY_CHECKS = 1;

    -- Verificación
    SELECT 'Base de datos inicializada correctamente' AS status;